<!DOCTYPE html>
<html lang="km">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>កម្មវិធីស្នើសុំច្បាប់</title>
    
    <!-- 1. Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. Load Google Font (Kantumruy Pro for Khmer) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kantumruy+Pro:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- 3. Load React & Babel -->
    <script src="https://unpkg.com/react@17/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
    
    <!-- 4. Load Firebase SDKs (Realtime Database) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    
    <style>
        /* Apply the Khmer font as default */
        body {
            font-family: 'Kantumruy Pro', sans-serif;
        }
        /* Custom scrollbar for aesthetics */
        ::-webkit-scrollbar {
            width: 6px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #c4c4c4;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #a1a1a1;
        }
    </style>
</head>
<body class="bg-gray-100">

    <!-- This is the root element where our React app will be mounted -->
    <div id="root"></div>

    <!-- 5. React/JSX Code using text/babel -->
    <script type="text/babel">
        
        // Make React functions available
        const { useState, useEffect, useMemo } = React;
        
        // Make Firebase functions available
        const { initializeApp } = firebase;
        const { getDatabase, ref, onValue, push, set } = firebase.database;

        // --- Firebase Configuration ---

        // Config 1: For Name List (Read-Only)
        const firebaseConfigNames = {
            apiKey: "AIzaSyAc2g-t9A7du3K_nI2fJnw_OGxhmLfpP6s",
            authDomain: "dilistname.firebaseapp.com",
            databaseURL: "https://dilistname-default-rtdb.firebaseio.com",
            projectId: "dilistname",
            storageBucket: "dilistname.firebasestorage.app",
            messagingSenderId: "897983357871",
            appId: "1:897983357871:web:42a046bc9fb3e0543dc55a",
            measurementId: "G-NQ798D9J6K"
        };

        // Config 2: For Leave Requests (Read/Write)
        const firebaseConfigPermissions = {
            apiKey: "AIzaSyDjr_Ha2RxOWEumjEeSdluIW3JmyM76mVk",
            authDomain: "dipermisstion.firebaseapp.com",
            databaseURL: "https://dipermisstion-default-rtdb.firebaseio.com/", // Ensure databaseURL is set for RTDB
            projectId: "dipermisstion",
            storageBucket: "dipermisstion.firebasestorage.app",
            messagingSenderId: "512999406057",
            appId: "1:512999406057:web:953a281ab9dde7a9a0f378",
            measurementId: "G-KDPHXZ7H4B"
        };

        // --- Initialize Firebase Apps ---
        // We must give unique names when initializing multiple apps
        let nameApp;
        let permissionApp;

        // Check if apps are already initialized to prevent errors on hot-reload
        if (!firebase.apps.some(app => app.name === "nameApp")) {
            nameApp = initializeApp(firebaseConfigNames, "nameApp");
        } else {
            nameApp = firebase.app("nameApp");
        }

        if (!firebase.apps.some(app => app.name === "permissionApp")) {
            permissionApp = initializeApp(firebaseConfigPermissions, "permissionApp");
        } else {
            permissionApp = firebase.app("permissionApp");
        }


        // --- Get Database Instances ---
        const nameDB = getDatabase(nameApp);
        const permissionDB = getDatabase(permissionApp);

        // --- Main React Component ---
        function App() {
            // --- State Definitions ---
            
            // Data state
            const [names, setNames] = useState([]);
            const [leaveRequests, setLeaveRequests] = useState([]);
            
            // Form state
            const [selectedName, setSelectedName] = useState("");
            const [leaveType, setLeaveType] = useState("ឈប់សម្រាក"); // 'ឈប់សម្រាក' or 'ចេញក្រៅ'
            const [leaveDate, setLeaveDate] = useState(new Date().toISOString().split('T')[0]); // Default to today
            const [reason, setReason] = useState("");
            
            // UI/Loading state
            const [isLoadingNames, setIsLoadingNames] = useState(true);
            const [isSubmitting, setIsSubmitting] = useState(false);
            const [statusMessage, setStatusMessage] = useState(""); // For success/error messages

            // --- Data Fetching Effect ---
            useEffect(() => {
                // 1. Fetch Name List (from nameDB)
                // !! សំខាន់: សូមកែ 'employee_list' ទៅតាម Path ពិតប្រាកដនៅក្នុង Realtime DB របស់អ្នក
                const namesRef = ref(nameDB, 'employee_list/'); 
                
                setIsLoadingNames(true);
                onValue(namesRef, (snapshot) => {
                    const data = snapshot.val();
                    // ដំណើរការទិន្នន័យ មិនថាវាជា Array ឬ Object ក៏ដោយ
                    if (Array.isArray(data)) {
                        setNames(data.filter(name => name)); // Filter out any null/empty entries
                    } else if (typeof data === 'object' && data !== null) {
                        // បើទិន្នន័យជា Object ដូចជា { "id1": "Sok", "id2": "Sao" }
                        setNames(Object.values(data));
                    } else {
                        console.warn("មិនអាចទាញយកបញ្ជីឈ្មោះ ឬទិន្នន័យទទេ");
                        setNames([]);
                    }
                    setIsLoadingNames(false);
                }, (error) => {
                    console.error("Firebase Name DB Error:", error);
                    setStatusMessage("មិនអាចទាញយកបញ្ជីឈ្មោះបានទេ");
                    setIsLoadingNames(false);
                });

                // 2. Fetch Leave Requests (from permissionDB)
                // !! សំខាន់: សូមកែ 'leave_requests' ទៅតាម Path ពិតប្រាកដ
                const requestsRef = ref(permissionDB, 'leave_requests/');
                
                onValue(requestsRef, (snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        // បំប្លែង Object ទៅជា Array ហើយ Sort តាម timestamp (ថ្មីមុន)
                        const loadedRequests = Object.keys(data)
                            .map(key => ({ id: key, ...data[key] }))
                            .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                        setLeaveRequests(loadedRequests);
                    } else {
                        setLeaveRequests([]);
                    }
                }, (error) => {
                    console.error("Firebase Permission DB Error:", error);
                    setStatusMessage("មិនអាចទាញយកប្រវត្តិស្នើសុំបានទេ");
                });

            }, []); // Run only once on component mount

            // --- Form Submit Handler ---
            const handleSubmit = (e) => {
                e.preventDefault();

                // Validation
                if (!selectedName || !leaveDate || !reason) {
                    showStatus("សូមបំពេញព័ត៌មានឲ្យបានគ្រប់គ្រាន់", "error");
                    return;
                }

                setIsSubmitting(true);
                
                const newRequest = {
                    name: selectedName,
                    type: leaveType,
                    date: leaveDate,
                    reason: reason,
                    timestamp: new Date().toISOString(), // For sorting
                    status: "រង់ចាំ" // Default status
                };

                // !! សំខាន់: Path សម្រាប់រក្សាទុក
                const newRequestRef = push(ref(permissionDB, 'leave_requests/'));

                set(newRequestRef, newRequest)
                    .then(() => {
                        showStatus("ការស្នើសុំបានជោគជ័យ!", "success");
                        // Clear the form
                        // setSelectedName(""); // Maybe keep the name?
                        setReason("");
                        setLeaveDate(new Date().toISOString().split('T')[0]);
                    })
                    .catch((error) => {
                        console.error("Error writing to Firebase:", error);
                        showStatus("មានបញ្ហាក្នុងការស្នើសុំ", "error");
                    })
                    .finally(() => {
                        setIsSubmitting(false);
                    });
            };

            // --- Helper Function for Status Messages ---
            const showStatus = (message, type = "success") => {
                const isError = type === 'error';
                setStatusMessage({ text: message, error: isError });
                
                // Clear message after 3 seconds
                setTimeout(() => {
                    setStatusMessage("");
                }, 3000);
            };

            // --- Render Helper for Name Options ---
            const renderNameOptions = () => {
                if (isLoadingNames) {
                    return <option value="" disabled>កំពុងទាញយកឈ្មោះ...</option>;
                }
                if (names.length === 0) {
                    return <option value="" disabled>មិនមានឈ្មោះក្នុងបញ្ជី</option>;
                }
                return (
                    <>
                        <option value="" disabled>-- សូមជ្រើសរើសឈ្មោះ --</option>
                        {names.map((name, index) => (
                            <option key={index} value={name}>{name}</option>
                        ))}
                    </>
                );
            };
            
            // --- Helper to format date for display ---
            const formatDisplayDate = (isoDate) => {
                try {
                    const date = new Date(isoDate);
                    // This will use the local timezone, which is usually what's intended for a simple date input
                    const yyyy = date.getFullYear();
                    const mm = String(date.getMonth() + 1).padStart(2, '0');
                    const dd = String(date.getDate()).padStart(2, '0');
                    return `${dd}-${mm}-${yyyy}`;
                } catch (e) {
                    return isoDate; // Fallback
                }
            }

            // --- Main JSX Render ---
            return (
                <div className="max-w-md mx-auto min-h-screen bg-white shadow-2xl flex flex-col">
                    {/* 1. Header */}
                    <header className="bg-blue-600 text-white p-5 shadow-md">
                        <h1 className="text-2xl font-bold text-center">កម្មវិធីស្នើសុំច្បាប់</h1>
                    </header>

                    {/* 2. Main Content Area (Scrollable) */}
                    <main className="flex-1 overflow-y-auto p-4 md:p-6 space-y-6 bg-gray-50">
                        {/* Form Section */}
                        <form onSubmit={handleSubmit} className="bg-white p-5 rounded-xl shadow-md space-y-5">
                            <h2 className="text-xl font-semibold text-gray-800 border-b pb-2">១. បំពេញពាក្យស្នើសុំ</h2>
                            
                            {/* Name Selector */}
                            <div>
                                <label htmlFor="name" className="block text-sm font-medium text-gray-700 mb-1">ឈ្មោះបុគ្គលិក</label>
                                <select
                                    id="name"
                                    value={selectedName}
                                    onChange={(e) => setSelectedName(e.target.value)}
                                    className="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white"
                                    required
                                >
                                    {renderNameOptions()}
                                </select>
                            </div>
                            
                            {/* Leave Type Selector (Segmented Control) */}
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">ប្រភេទច្បាប់</label>
                                <div className="flex rounded-md shadow-sm">
                                    <button
                                        type="button"
                                        onClick={() => setLeaveType("ឈប់សម្រាក")}
                                        className={`flex-1 px-4 py-2 rounded-l-md border border-gray-300 transition-colors ${
                                            leaveType === "ឈប់សម្រាក"
                                                ? 'bg-blue-600 text-white font-semibold z-10'
                                                : 'bg-white text-gray-700 hover:bg-gray-50'
                                        }`}
                                    >
                                        ឈប់សម្រាក
                                    </button>
                                    <button
                                        type="button"
                                        onClick={() => setLeaveType("ចេញក្រៅ")}
                                        className={`flex-1 px-4 py-2 rounded-r-md border border-gray-300 -ml-px transition-colors ${
                                            leaveType === "ចេញក្រៅ"
                                                ? 'bg-blue-600 text-white font-semibold z-10'
                                                : 'bg-white text-gray-700 hover:bg-gray-50'
                                        }`}
                                    >
                                        ចេញក្រៅ
                                    </button>
                                </div>
                            </div>
                            
                            {/* Date Picker */}
                            <div>
                                <label htmlFor="date" className="block text-sm font-medium text-gray-700 mb-1">កាលបរិច្ឆេទ</label>
                                <input
                                    type="date"
                                    id="date"
                                    value={leaveDate}
                                    onChange={(e) => setLeaveDate(e.target.value)}
                                    className="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    required
                                />
                            </div>
                            
                            {/* Reason */}
                            <div>
                                <label htmlFor="reason" className="block text-sm font-medium text-gray-700 mb-1">មូលហេតុ</label>
                                <textarea
                                    id="reason"
                                    rows="3"
                                    value={reason}
                                    onChange={(e) => setReason(e.target.value)}
                                    className="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    placeholder="សូមសរសេរមូលហេតុខ្លីៗ..."
                                    required
                                ></textarea>
                            </div>

                            {/* Status Message */}
                            {statusMessage.text && (
                                <div className={`p-3 rounded-md text-center text-sm font-medium ${
                                    statusMessage.error
                                        ? 'bg-red-100 text-red-700'
                                        : 'bg-green-100 text-green-700'
                                }`}>
                                    {statusMessage.text}
                                </div>
                            )}

                            {/* Submit Button */}
                            <button
                                type="submit"
                                disabled={isSubmitting || isLoadingNames}
                                className="w-full py-3 px-4 bg-blue-600 text-white font-semibold rounded-md shadow-md transition-all
                                           hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2
                                           disabled:bg-gray-400 disabled:cursor-not-allowed flex items-center justify-center space-x-2"
                            >
                                {isSubmitting && (
                                    <svg className="animate-spin -ml-1 mr-2 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                        <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                                        <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                    </svg>
                                )}
                                <span>{isSubmitting ? "កំពុងស្នើសុំ..." : "ស្នើសុំ"}</span>
                            </button>
                        </form>
                        
                        {/* History Section */}
                        <div className="space-y-4">
                            <h2 className="text-xl font-semibold text-gray-800 border-b pb-2">២. ប្រវត្តិស្នើសុំ (ថ្មី-ចាស់)</h2>
                            
                            {leaveRequests.length === 0 ? (
                                <div className="text-center text-gray-500 bg-white p-6 rounded-xl shadow-sm">
                                    មិនទាន់មានការស្នើសុំ
                                </div>
                            ) : (
                                <ul className="space-y-3">
                                    {leaveRequests.map((req) => (
                                        <li key={req.id} className="bg-white p-4 rounded-lg shadow-sm border border-gray-200">
                                            <div className="flex justify-between items-start">
                                                <div className="flex-1">
                                                    <p className="font-semibold text-blue-700 text-lg">{req.name}</p>
                                                    <p className="text-sm text-gray-600">
                                                        <span className="font-medium">កាលបរិច្ឆេទ:</span> {formatDisplayDate(req.date)}
                                                    </p>
                                                    <p className="text-sm text-gray-600">
                                                        <span className="font-medium">ប្រភេទ:</span> {req.type}
                                                    </p>
                                                    <p className="text-gray-800 mt-2">{req.reason}</p>
                                                </div>
                                                <span className={`px-2.5 py-0.5 rounded-full text-xs font-medium ${
                                                    req.status === 'រង់ចាំ' ? 'bg-yellow-100 text-yellow-800' :
                                                    req.status === 'យល់ព្រម' ? 'bg-green-100 text-green-800' :
                                                    'bg-red-100 text-red-800'
                                                }`}>
                                                    {req.status || 'រង់ចាំ'}
                                                </span>
                                            </div>
                                        </li>
                                    ))}
                                </ul>
                            )}
                        </div>
                    </main>
                </div>
            );
        }

        // --- Mount the React App ---
        ReactDOM.render(<App />, document.getElementById('root'));

    </script>

</body>
</html>
